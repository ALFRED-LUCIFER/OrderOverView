<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üîç Frontend WebSocket Connection Test</h1>
    <div id="status">Testing...</div>
    <div id="logs"></div>
    
    <script src="https://cdn.socket.io/4.7.0/socket.io.min.js"></script>
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        // Test environment variables (if available)
        log('üîß Testing environment variables...');
        
        try {
            // These would be available in the actual frontend build
            const apiUrl = 'http://localhost:3001'; // Fallback for this test
            const wsUrl = 'ws://localhost:3001'; // Fallback for this test
            
            log(`API URL: ${apiUrl}`, 'info');
            log(`WebSocket URL: ${wsUrl}`, 'info');
        } catch (error) {
            log(`Environment error: ${error.message}`, 'warning');
        }

        // Test WebSocket connection
        log('üîå Testing WebSocket connection...');
        updateStatus('Connecting to WebSocket...', 'info');
        
        const socket = io('ws://localhost:3001', {
            timeout: 10000,
            transports: ['websocket', 'polling']
        });
        
        let connected = false;
        
        socket.on('connect', () => {
            connected = true;
            log(`‚úÖ WebSocket connected successfully! Socket ID: ${socket.id}`, 'success');
            log(`Transport: ${socket.io.engine.transport.name}`, 'info');
            updateStatus('WebSocket: Connected!', 'success');
        });
        
        socket.on('connected', (data) => {
            log('üéâ LISA backend responded:', 'success');
            log(`Session: ${data.sessionId}`, 'info');
            log(`Agent: ${data.agent}`, 'info');
            log(`Message: ${data.message}`, 'info');
            updateStatus('LISA: Ready!', 'success');
        });
        
        socket.on('connect_error', (error) => {
            log(`‚ùå WebSocket connection error: ${error.message}`, 'error');
            log(`Error type: ${error.type}`, 'error');
            updateStatus('WebSocket: Failed!', 'error');
            
            if (error.message.includes('xhr poll error')) {
                log('This suggests a CORS issue with XHR polling transport', 'warning');
            } else if (error.message.includes('websocket error')) {
                log('WebSocket transport failed, trying polling...', 'warning');
            }
        });
        
        socket.on('disconnect', (reason) => {
            log(`üîå Disconnected: ${reason}`, 'warning');
            updateStatus('WebSocket: Disconnected', 'warning');
        });
        
        // Timeout after 15 seconds
        setTimeout(() => {
            if (!connected) {
                log('‚è∞ Connection timeout after 15 seconds', 'error');
                updateStatus('WebSocket: Timeout!', 'error');
            }
        }, 15000);
        
        // Test API connection
        setTimeout(() => {
            log('üåê Testing API connection...');
            fetch('http://localhost:3001/api/customers')
                .then(response => {
                    if (response.ok) {
                        log('‚úÖ API connection successful', 'success');
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .then(data => {
                    log(`Found ${data.length} customers in database`, 'info');
                })
                .catch(error => {
                    log(`‚ùå API connection failed: ${error.message}`, 'error');
                });
        }, 2000);
    </script>
</body>
</html>
