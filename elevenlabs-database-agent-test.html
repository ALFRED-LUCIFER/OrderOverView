<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs Conversational AI Database Agent Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 5px;
        }
        
        .status.connected { background: rgba(76, 175, 80, 0.3); }
        .status.disconnected { background: rgba(244, 67, 54, 0.3); }
        .status.speaking { background: rgba(255, 193, 7, 0.3); }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }
        
        .control-group h3 {
            margin-top: 0;
            color: #ffd700;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-area {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .conversation {
            height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            animation: fadeIn 0.3s ease;
        }
        
        .message.user {
            background: rgba(103, 126, 234, 0.3);
            margin-left: 20px;
        }
        
        .message.assistant {
            background: rgba(118, 75, 162, 0.3);
            margin-right: 20px;
        }
        
        .message.system {
            background: rgba(255, 193, 7, 0.3);
            text-align: center;
            font-style: italic;
        }
        
        .message.function {
            background: rgba(76, 175, 80, 0.3);
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ ElevenLabs AI Database Agent</h1>
            <p>Voice-powered database operations with natural language processing</p>
            <div id="connection-status" class="status disconnected">‚ö´ Disconnected</div>
            <div id="speech-status" class="status">üîá Silent</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>üîå Connection</h3>
                <button onclick="connectToBackend()">Connect to LISA Backend</button>
                <button onclick="initializeAgent()">Initialize ElevenLabs Agent</button>
                <button onclick="startConversation()">Start Conversation</button>
            </div>

            <div class="control-group">
                <h3>üîç Search Operations</h3>
                <button onclick="testSearch('Show me all orders')">All Orders</button>
                <button onclick="testSearch('Find bulletproof glass orders')">Bulletproof Glass</button>
                <button onclick="testSearch('Search orders above $20,000')">High Value Orders</button>
                <button onclick="testSearch('Get pending orders from this week')">Pending Orders</button>
            </div>

            <div class="control-group">
                <h3>üìä Analytics</h3>
                <button onclick="testSearch('Show me the top 10 most profitable orders')">Top 10 Profitable</button>
                <button onclick="testSearch('What are our highest value orders?')">Highest Value</button>
                <button onclick="testSearch('Find the most expensive deliveries')">Expensive Deliveries</button>
                <button onclick="testSearch('Show customer analytics')">Customer Analytics</button>
            </div>

            <div class="control-group">
                <h3>‚ûï Order Management</h3>
                <button onclick="testCreate()">Create Test Order</button>
                <button onclick="testUpdate()">Update Order Status</button>
                <button onclick="testSearch('Generate quarterly report')">Generate Report</button>
                <button onclick="testSearch('Show revenue analytics')">Revenue Analytics</button>
            </div>
        </div>

        <div class="test-area">
            <h3>üí¨ Conversation</h3>
            <div id="conversation" class="conversation"></div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Type your command or question..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">Send</button>
                <button onclick="startVoiceInput()" id="voiceBtn">üé§ Voice</button>
            </div>
        </div>

        <div class="metrics">
            <div class="metric">
                <div id="totalQueries" class="metric-value">0</div>
                <div class="metric-label">Total Queries</div>
            </div>
            <div class="metric">
                <div id="successfulOps" class="metric-value">0</div>
                <div class="metric-label">Successful Operations</div>
            </div>
            <div class="metric">
                <div id="avgResponseTime" class="metric-value">0ms</div>
                <div class="metric-label">Avg Response Time</div>
            </div>
            <div class="metric">
                <div id="ordersFound" class="metric-value">0</div>
                <div class="metric-label">Orders Found</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        class ElevenLabsDBAgent {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.conversationId = null;
                this.metrics = {
                    totalQueries: 0,
                    successfulOps: 0,
                    responseTimes: [],
                    ordersFound: 0
                };
                
                // Mock ElevenLabs agent (in real implementation, use ElevenLabs SDK)
                this.agentConfig = {
                    apiKey: 'sk_1e3890ea4390a3dc3cb9ae9d32588befd0d02a65b61cb499',
                    voiceId: 'EXAVITQu4vr4xnSDxMaL',
                    agentId: 'lisa-db-agent'
                };
            }

            // Connect to LISA backend
            connectToBackend() {
                this.addMessage('system', 'üîå Connecting to LISA backend...');
                
                this.socket = io('http://localhost:3001', {
                    transports: ['websocket'],
                    timeout: 10000
                });

                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateConnectionStatus('connected', '‚úÖ Connected to LISA');
                    this.addMessage('system', '‚úÖ Connected to LISA backend successfully');
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus('disconnected', '‚ö´ Disconnected');
                    this.addMessage('system', '‚ùå Disconnected from LISA backend');
                });

                this.socket.on('voice-response', (data) => {
                    this.handleLISAResponse(data);
                });

                this.socket.on('connect_error', (error) => {
                    this.addMessage('system', `‚ùå Connection error: ${error.message}`);
                });
            }

            // Initialize ElevenLabs agent (mock implementation)
            async initializeAgent() {
                this.addMessage('system', 'ü§ñ Initializing ElevenLabs Conversational AI Agent...');
                
                try {
                    // Mock agent initialization
                    await this.mockDelay(2000);
                    
                    this.addMessage('assistant', 'Hello! I\'m LISA, your AI assistant for glass order management. I can help you search orders, find top profit records, create new orders, and much more. What would you like me to help you with today?');
                    this.addMessage('system', '‚úÖ ElevenLabs agent initialized successfully');
                    
                } catch (error) {
                    this.addMessage('system', `‚ùå Agent initialization failed: ${error.message}`);
                }
            }

            // Start conversation
            async startConversation() {
                if (!this.isConnected) {
                    this.addMessage('system', '‚ö†Ô∏è Please connect to backend first');
                    return;
                }

                this.conversationId = `conv-${Date.now()}`;
                this.addMessage('system', `üé§ Conversation started (ID: ${this.conversationId})`);
                this.addMessage('assistant', 'Great! I\'m ready to help you with database operations. You can ask me to search orders, find top profits, create orders, or update statuses. What would you like to do?');
            }

            // Send message to agent
            async sendMessage(text) {
                if (!text.trim()) return;

                const startTime = Date.now();
                this.metrics.totalQueries++;
                this.updateMetrics();

                this.addMessage('user', text);
                this.updateSpeechStatus('üîÑ Processing...');

                try {
                    // Simulate ElevenLabs agent processing
                    await this.mockDelay(1000);
                    
                    // Send to LISA backend for database operations
                    if (this.isConnected) {
                        this.socket.emit('voice-command', {
                            transcript: text,
                            isEndOfSpeech: true,
                            interimResults: false,
                            useNaturalConversation: true,
                            elevenLabsAgent: true,
                            conversationId: this.conversationId
                        });
                    } else {
                        this.addMessage('assistant', 'I understand your request, but I need to be connected to the database to perform operations. Please connect to the LISA backend first.');
                    }

                    const responseTime = Date.now() - startTime;
                    this.metrics.responseTimes.push(responseTime);
                    this.updateMetrics();

                } catch (error) {
                    this.addMessage('system', `‚ùå Error: ${error.message}`);
                } finally {
                    this.updateSpeechStatus('üîá Silent');
                }
            }

            // Handle LISA backend response
            handleLISAResponse(data) {
                this.updateSpeechStatus('üé§ Speaking...');
                
                // Add natural agent response
                let agentResponse = this.generateAgentResponse(data);
                this.addMessage('assistant', agentResponse);

                // Show function call details if available
                if (data.data) {
                    this.addMessage('function', `Database operation: ${JSON.stringify(data.data, null, 2)}`);
                    
                    if (data.data.orders) {
                        this.metrics.ordersFound += data.data.orders.length;
                    }
                    
                    this.metrics.successfulOps++;
                    this.updateMetrics();
                }

                // Simulate speech
                setTimeout(() => {
                    this.updateSpeechStatus('üîá Silent');
                }, 3000);
            }

            // Generate natural agent response
            generateAgentResponse(data) {
                const responses = {
                    search_results: [
                        `I found ${data.data?.count || 0} orders matching your criteria.`,
                        `Here are the search results: ${data.data?.count || 0} orders found.`,
                        `Great! I located ${data.data?.count || 0} orders in the database.`
                    ],
                    order_created: [
                        `Perfect! I've created a new order with ID ${data.data?.id || 'unknown'}.`,
                        `Order created successfully! Your order number is ${data.data?.orderNumber || 'unknown'}.`,
                        `Done! The new order has been added to the database.`
                    ],
                    order_updated: [
                        `Order ${data.data?.orderNumber || 'unknown'} has been updated successfully.`,
                        `Status update complete! The order is now marked as ${data.data?.newStatus || 'updated'}.`,
                        `Perfect! I've updated the order status in the database.`
                    ]
                };

                const responseArray = responses[data.action] || [
                    `I've processed your request successfully.`,
                    `Operation completed! Here's what I found.`,
                    `Got it! I've handled your database query.`
                ];

                const baseResponse = responseArray[Math.floor(Math.random() * responseArray.length)];
                
                // Add specific details
                if (data.data?.orders && data.data.orders.length > 0) {
                    const topOrder = data.data.orders[0];
                    return `${baseResponse} The top result is order ${topOrder.orderNumber} for ${topOrder.customerName} worth $${topOrder.totalPrice?.toLocaleString()} for ${topOrder.glassType} glass, currently ${topOrder.status}. Would you like more details?`;
                }

                return baseResponse;
            }

            // Test functions
            testSearch(query) {
                this.sendMessage(query);
            }

            testCreate() {
                const testQueries = [
                    "Create a new order for Pentagon Security with 25 bulletproof windows",
                    "Add an order for John Doe with 10 tempered glass panels",
                    "New order: 5 laminated glass for Hotel Magnifico"
                ];
                const randomQuery = testQueries[Math.floor(Math.random() * testQueries.length)];
                this.sendMessage(randomQuery);
            }

            testUpdate() {
                const testQueries = [
                    "Mark order ORD-123 as delivered",
                    "Update order EXP-9001 status to production",
                    "Change order status to quality check for order QUAL-9007"
                ];
                const randomQuery = testQueries[Math.floor(Math.random() * testQueries.length)];
                this.sendMessage(randomQuery);
            }

            // UI Helper functions
            addMessage(type, content) {
                const conversation = document.getElementById('conversation');
                const message = document.createElement('div');
                message.className = `message ${type}`;
                
                const timestamp = new Date().toLocaleTimeString();
                const typeEmoji = {
                    user: 'üë§',
                    assistant: 'ü§ñ',
                    system: '‚öôÔ∏è',
                    function: 'üîß'
                };
                
                message.innerHTML = `
                    <strong>${typeEmoji[type]} ${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <span style="float: right; opacity: 0.6; font-size: 0.8rem;">${timestamp}</span>
                    <div style="margin-top: 5px;">${content}</div>
                `;
                
                conversation.appendChild(message);
                conversation.scrollTop = conversation.scrollHeight;
            }

            updateConnectionStatus(status, text) {
                const statusEl = document.getElementById('connection-status');
                statusEl.className = `status ${status}`;
                statusEl.textContent = text;
            }

            updateSpeechStatus(text) {
                const statusEl = document.getElementById('speech-status');
                statusEl.textContent = text;
                statusEl.className = text.includes('Speaking') ? 'status speaking' : 'status';
            }

            updateMetrics() {
                document.getElementById('totalQueries').textContent = this.metrics.totalQueries;
                document.getElementById('successfulOps').textContent = this.metrics.successfulOps;
                document.getElementById('ordersFound').textContent = this.metrics.ordersFound;
                
                const avgTime = this.metrics.responseTimes.length > 0 
                    ? Math.round(this.metrics.responseTimes.reduce((a, b) => a + b, 0) / this.metrics.responseTimes.length)
                    : 0;
                document.getElementById('avgResponseTime').textContent = `${avgTime}ms`;
            }

            mockDelay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize agent
        const agent = new ElevenLabsDBAgent();

        // UI Event handlers
        function connectToBackend() {
            agent.connectToBackend();
        }

        function initializeAgent() {
            agent.initializeAgent();
        }

        function startConversation() {
            agent.startConversation();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            agent.sendMessage(input.value);
            input.value = '';
        }

        function testSearch(query) {
            agent.testSearch(query);
        }

        function testCreate() {
            agent.testCreate();
        }

        function testUpdate() {
            agent.testUpdate();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function startVoiceInput() {
            // Mock voice input (in real implementation, use Web Speech API)
            const testCommands = [
                "Show me all bulletproof glass orders",
                "Find the top 5 most profitable orders",
                "Create a new order for ABC Corp with 15 tempered glass panels",
                "Update order EXP-9001 to delivered status"
            ];
            
            const randomCommand = testCommands[Math.floor(Math.random() * testCommands.length)];
            document.getElementById('messageInput').value = randomCommand;
            
            // Auto-send after 2 seconds
            setTimeout(() => {
                sendMessage();
            }, 2000);
        }

        // Auto-connect on page load
        window.addEventListener('load', () => {
            agent.addMessage('system', 'üöÄ ElevenLabs Conversational AI Database Agent loaded');
            agent.addMessage('system', 'Click "Connect to LISA Backend" to start');
        });
    </script>
</body>
</html>
