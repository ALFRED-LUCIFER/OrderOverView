<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LISA Voice Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1565c0; }
        .voice-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .voice-item {
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        .voice-item:hover {
            background: #f0f0f0;
        }
        .voice-item.selected {
            background: #e3f2fd;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¤ LISA Voice Test</h1>
    
    <div class="test-card">
        <h3>1. Browser Speech Synthesis Test</h3>
        <button onclick="testBasicSpeech()">Test Basic Speech</button>
        <button onclick="testLISAVoice()">Test LISA Voice</button>
        <button onclick="stopSpeech()">Stop Speech</button>
        <div id="speechStatus" class="status info">Ready to test speech synthesis</div>
    </div>

    <div class="test-card">
        <h3>2. Available Voices</h3>
        <button onclick="loadVoices()">Load Available Voices</button>
        <div id="voiceList" class="voice-list">Click "Load Available Voices" to see available voices</div>
    </div>

    <div class="test-card">
        <h3>3. LISA Connection Test</h3>
        <button onclick="testLISAConnection()">Test WebSocket Connection</button>
        <button onclick="simulateVoiceCommand()">Simulate Voice Command</button>
        <div id="connectionStatus" class="status info">Ready to test LISA connection</div>
    </div>

    <div class="test-card">
        <h3>4. Browser Permissions</h3>
        <button onclick="checkPermissions()">Check Microphone Permission</button>
        <div id="permissionStatus" class="status info">Click to check microphone permissions</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let selectedVoice = null;
        let socket = null;

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function testBasicSpeech() {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('Hello! This is a basic speech synthesis test.');
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                utterance.onstart = () => updateStatus('speechStatus', 'Speaking...', 'info');
                utterance.onend = () => updateStatus('speechStatus', 'Speech completed successfully!', 'success');
                utterance.onerror = (e) => updateStatus('speechStatus', `Speech error: ${e.error}`, 'error');
                
                window.speechSynthesis.speak(utterance);
            } else {
                updateStatus('speechStatus', 'Speech synthesis not supported in this browser', 'error');
            }
        }

        function testLISAVoice() {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('Hello! I am LISA, your Language Intelligence Support Assistant. I am ready to help you with your glass manufacturing orders.');
                
                // Use selected voice if available
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                // LISA voice configuration
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                utterance.onstart = () => updateStatus('speechStatus', 'LISA is speaking...', 'info');
                utterance.onend = () => updateStatus('speechStatus', 'LISA speech completed!', 'success');
                utterance.onerror = (e) => updateStatus('speechStatus', `LISA speech error: ${e.error}`, 'error');
                
                window.speechSynthesis.speak(utterance);
            } else {
                updateStatus('speechStatus', 'Speech synthesis not supported', 'error');
            }
        }

        function stopSpeech() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                updateStatus('speechStatus', 'Speech stopped', 'info');
            }
        }

        function loadVoices() {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                const voiceList = document.getElementById('voiceList');
                
                if (voices.length === 0) {
                    voiceList.innerHTML = '<em>No voices available or still loading...</em>';
                    // Try again after a delay
                    setTimeout(loadVoices, 1000);
                    return;
                }
                
                voiceList.innerHTML = '';
                voices.forEach((voice, index) => {
                    const voiceItem = document.createElement('div');
                    voiceItem.className = 'voice-item';
                    voiceItem.textContent = `${voice.name} (${voice.lang}) ${voice.default ? '[Default]' : ''}`;
                    voiceItem.onclick = () => {
                        document.querySelectorAll('.voice-item').forEach(item => item.classList.remove('selected'));
                        voiceItem.classList.add('selected');
                        selectedVoice = voice;
                        updateStatus('speechStatus', `Selected voice: ${voice.name}`, 'success');
                    };
                    voiceList.appendChild(voiceItem);
                });
            }
        }

        function testLISAConnection() {
            try {
                socket = io('ws://localhost:3001');
                
                socket.on('connect', () => {
                    updateStatus('connectionStatus', 'Connected to LISA WebSocket!', 'success');
                });
                
                socket.on('connected', (data) => {
                    updateStatus('connectionStatus', `LISA connected with session: ${data.sessionId}`, 'success');
                });
                
                socket.on('voice-response', (data) => {
                    updateStatus('connectionStatus', `LISA responded: ${data.response || 'No response text'}`, 'success');
                    
                    if (data.response && data.shouldSpeak) {
                        const utterance = new SpeechSynthesisUtterance(data.response);
                        if (selectedVoice) utterance.voice = selectedVoice;
                        utterance.rate = 0.9;
                        utterance.pitch = 1.0;
                        utterance.volume = 0.8;
                        window.speechSynthesis.speak(utterance);
                    }
                });
                
                socket.on('connect_error', (error) => {
                    updateStatus('connectionStatus', `Connection error: ${error.message}`, 'error');
                });
                
                socket.on('disconnect', () => {
                    updateStatus('connectionStatus', 'Disconnected from LISA', 'error');
                });
                
            } catch (error) {
                updateStatus('connectionStatus', `Error: ${error.message}`, 'error');
            }
        }

        function simulateVoiceCommand() {
            if (socket && socket.connected) {
                socket.emit('voice-command', { 
                    transcript: 'Hello LISA, can you help me?',
                    isEndOfSpeech: true,
                    interimResults: false,
                    useNaturalConversation: true
                });
                updateStatus('connectionStatus', 'Sent test voice command to LISA', 'info');
            } else {
                updateStatus('connectionStatus', 'Not connected to LISA. Test connection first.', 'error');
            }
        }

        async function checkPermissions() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                updateStatus('permissionStatus', 'Microphone permission granted!', 'success');
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                updateStatus('permissionStatus', `Microphone permission denied: ${error.message}`, 'error');
            }
        }

        // Load voices when page loads
        window.addEventListener('load', () => {
            if ('speechSynthesis' in window) {
                // Voices might not be loaded immediately
                setTimeout(loadVoices, 500);
                window.speechSynthesis.addEventListener('voiceschanged', loadVoices);
            }
        });
    </script>
</body>
</html>
