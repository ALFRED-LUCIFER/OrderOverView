<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome Audio Test - LISA Voice System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        
        button {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .primary { background: #007bff; color: white; }
        .success-btn { background: #28a745; color: white; }
        .warning-btn { background: #ffc107; color: #212529; }
        .danger { background: #dc3545; color: white; }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .step {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
        }
        
        h1 { color: #333; text-align: center; }
        h2 { color: #666; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Chrome Audio Test - LISA Voice System</h1>
        
        <div class="test-section">
            <h2>üîç Browser Compatibility Check</h2>
            <div id="compatibility-status" class="status info">
                Checking browser compatibility...
            </div>
            <div id="browser-info" class="code"></div>
        </div>
        
        <div class="test-section">
            <h2>üîê Audio Permissions Test</h2>
            <div id="permission-status" class="status warning">
                Click "Test Audio Permissions" to begin
            </div>
            <button id="permission-btn" class="primary" onclick="testPermissions()">
                Test Audio Permissions
            </button>
        </div>
        
        <div class="test-section">
            <h2>üó£Ô∏è Speech Synthesis Test</h2>
            <div id="speech-status" class="status warning">
                Audio permissions required first
            </div>
            <button id="speech-btn" class="success-btn" onclick="testSpeech()" disabled>
                Test Speech Synthesis
            </button>
            <button id="stop-btn" class="danger" onclick="stopSpeech()" disabled>
                Stop Speech
            </button>
        </div>
        
        <div class="test-section">
            <h2>ü§ñ LISA Voice Test</h2>
            <div id="lisa-status" class="status warning">
                Complete previous tests first
            </div>
            <button id="lisa-btn" class="primary" onclick="testLISA()" disabled>
                Test LISA Voice
            </button>
        </div>
        
        <div class="test-section">
            <h2>üìã Test Results</h2>
            <div id="results"></div>
        </div>
        
        <div class="test-section">
            <h2>üîß Chrome Audio Troubleshooting</h2>
            <div class="step">
                <strong>Step 1:</strong> Make sure you're on HTTPS or localhost
                <div class="code">Current: <span id="current-protocol"></span></div>
            </div>
            <div class="step">
                <strong>Step 2:</strong> Check Chrome site settings
                <div class="code">chrome://settings/content/sound</div>
            </div>
            <div class="step">
                <strong>Step 3:</strong> Allow autoplay for this site
                <div class="code">chrome://settings/content/soundContent</div>
            </div>
            <div class="step">
                <strong>Step 4:</strong> Click play icon in address bar if blocked
            </div>
        </div>
    </div>

    <script>
        let audioContext = null;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        
        // Browser compatibility check
        function checkCompatibility() {
            const browserInfo = {
                userAgent: navigator.userAgent,
                speechSynthesis: 'speechSynthesis' in window,
                audioContext: 'AudioContext' in window || 'webkitAudioContext' in window,
                protocol: window.location.protocol,
                hostname: window.location.hostname
            };
            
            document.getElementById('browser-info').innerHTML = `
                Browser: ${navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other'}<br>
                Protocol: ${browserInfo.protocol}<br>
                Hostname: ${browserInfo.hostname}<br>
                Speech Synthesis: ${browserInfo.speechSynthesis ? '‚úÖ' : '‚ùå'}<br>
                Audio Context: ${browserInfo.audioContext ? '‚úÖ' : '‚ùå'}
            `;
            
            document.getElementById('current-protocol').textContent = browserInfo.protocol + '//' + browserInfo.hostname;
            
            if (browserInfo.speechSynthesis && browserInfo.audioContext) {
                updateStatus('compatibility-status', 'success', '‚úÖ Browser fully compatible with LISA Voice System');
            } else {
                updateStatus('compatibility-status', 'error', '‚ùå Browser missing required audio features');
            }
            
            return browserInfo;
        }
        
        // Test audio permissions
        async function testPermissions() {
            updateStatus('permission-status', 'info', 'üîÑ Testing audio permissions...');
            
            try {
                // Create AudioContext on user interaction
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioCtx();
                
                console.log('AudioContext state:', audioContext.state);
                
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    console.log('AudioContext resumed, new state:', audioContext.state);
                }
                
                // Test basic audio capability
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
                
                updateStatus('permission-status', 'success', '‚úÖ Audio permissions granted and working');
                document.getElementById('speech-btn').disabled = false;
                
                // Load speech voices
                loadVoices();
                
            } catch (error) {
                console.error('Audio permission error:', error);
                updateStatus('permission-status', 'error', `‚ùå Audio permission failed: ${error.message}`);
            }
        }
        
        // Load speech voices
        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            console.log('Available voices:', voices.length);
            
            if (voices.length === 0) {
                // Wait for voices to load
                speechSynthesis.addEventListener('voiceschanged', () => {
                    const voices = speechSynthesis.getVoices();
                    console.log('Voices loaded:', voices.length);
                });
            }
        }
        
        // Test speech synthesis
        function testSpeech() {
            updateStatus('speech-status', 'info', 'üîÑ Testing speech synthesis...');
            
            try {
                const text = "Hello! This is a test of the Chrome audio system for LISA voice assistant.";
                currentUtterance = new SpeechSynthesisUtterance(text);
                
                // Configure utterance
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    // Try to find a good English voice
                    const englishVoice = voices.find(voice => 
                        voice.lang.startsWith('en') && 
                        (voice.name.includes('Google') || voice.name.includes('Microsoft'))
                    ) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                    
                    currentUtterance.voice = englishVoice;
                    console.log('Using voice:', englishVoice.name);
                }
                
                currentUtterance.rate = 0.9;
                currentUtterance.pitch = 1.0;
                currentUtterance.volume = 0.8;
                
                currentUtterance.onstart = () => {
                    updateStatus('speech-status', 'info', 'üó£Ô∏è Speaking...');
                    document.getElementById('stop-btn').disabled = false;
                };
                
                currentUtterance.onend = () => {
                    updateStatus('speech-status', 'success', '‚úÖ Speech synthesis working perfectly!');
                    document.getElementById('stop-btn').disabled = true;
                    document.getElementById('lisa-btn').disabled = false;
                };
                
                currentUtterance.onerror = (event) => {
                    updateStatus('speech-status', 'error', `‚ùå Speech error: ${event.error}`);
                    document.getElementById('stop-btn').disabled = true;
                };
                
                speechSynthesis.speak(currentUtterance);
                
            } catch (error) {
                console.error('Speech test error:', error);
                updateStatus('speech-status', 'error', `‚ùå Speech test failed: ${error.message}`);
            }
        }
        
        // Stop speech
        function stopSpeech() {
            speechSynthesis.cancel();
            updateStatus('speech-status', 'warning', '‚èπÔ∏è Speech stopped');
            document.getElementById('stop-btn').disabled = true;
        }
        
        // Test LISA integration
        function testLISA() {
            updateStatus('lisa-status', 'info', 'üîÑ Testing LISA voice integration...');
            
            const lisaMessages = [
                "Hello! I am LISA, your Language Intelligence Support Assistant.",
                "I can help you manage your glass manufacturing orders using voice commands.",
                "Try saying 'Show me all customers' or 'Create a new order' to interact with me.",
                "The audio system is now working perfectly in Chrome!"
            ];
            
            let messageIndex = 0;
            
            function speakNextMessage() {
                if (messageIndex < lisaMessages.length) {
                    const utterance = new SpeechSynthesisUtterance(lisaMessages[messageIndex]);
                    
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        const femaleVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('female') ||
                             voice.name.toLowerCase().includes('samantha') ||
                             voice.name.toLowerCase().includes('karen'))
                        ) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                        
                        utterance.voice = femaleVoice;
                    }
                    
                    utterance.rate = 0.85;
                    utterance.pitch = 1.1;
                    utterance.volume = 0.9;
                    
                    utterance.onend = () => {
                        messageIndex++;
                        if (messageIndex < lisaMessages.length) {
                            setTimeout(speakNextMessage, 1000);
                        } else {
                            updateStatus('lisa-status', 'success', '‚úÖ LISA voice system fully operational!');
                            showResults();
                        }
                    };
                    
                    utterance.onerror = (event) => {
                        updateStatus('lisa-status', 'error', `‚ùå LISA test failed: ${event.error}`);
                    };
                    
                    speechSynthesis.speak(utterance);
                    updateStatus('lisa-status', 'info', `üó£Ô∏è LISA speaking message ${messageIndex + 1} of ${lisaMessages.length}...`);
                }
            }
            
            speakNextMessage();
        }
        
        // Show test results
        function showResults() {
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="status success">
                    <h3>üéâ All Tests Passed!</h3>
                    <p>Your Chrome browser is now fully configured for LISA voice interactions.</p>
                    <p><strong>What's working:</strong></p>
                    <ul style="text-align: left; margin: 10px 0;">
                        <li>‚úÖ Audio Context initialization</li>
                        <li>‚úÖ Speech Synthesis API</li>
                        <li>‚úÖ Voice selection and configuration</li>
                        <li>‚úÖ LISA voice personality</li>
                        <li>‚úÖ Chrome autoplay policy compliance</li>
                    </ul>
                    <p><strong>Next step:</strong> Go to the main LISA interface and test voice commands!</p>
                </div>
            `;
        }
        
        // Utility function to update status
        function updateStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            checkCompatibility();
            
            // Auto-load voices
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    console.log('Voices loaded:', speechSynthesis.getVoices().length);
                });
            }
        });
        
        // Handle page visibility changes (Chrome suspends audio contexts)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    </script>
</body>
</html>
