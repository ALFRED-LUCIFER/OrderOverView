<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Environment Variable Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .code { font-family: monospace; background: #f8f9fa; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç Vercel Environment Variable Test</h1>
    <p>This page will check what environment variables are available on the deployed Vercel frontend.</p>
    
    <div id="results"></div>
    
    <h3>Manual WebSocket Test</h3>
    <button onclick="testWebSocket()">Test WebSocket Connection</button>
    <div id="websocket-results"></div>
    
    <script src="https://cdn.socket.io/4.7.0/socket.io.min.js"></script>
    <script>
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
        }
        
        function addWebSocketResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            document.getElementById('websocket-results').appendChild(div);
        }
        
        // Check environment variables immediately
        window.addEventListener('load', () => {
            addResult('<strong>Environment Variables Check:</strong>', 'info');
            
            // Check if import.meta.env is available
            if (typeof import === 'undefined') {
                addResult('‚ùå import.meta.env not available (this might be expected on deployed site)', 'warning');
                
                // Try to access via window (if exposed)
                if (window.__VITE_ENV) {
                    addResult('‚úÖ Found window.__VITE_ENV', 'success');
                    addResult(`API URL: <span class="code">${window.__VITE_ENV.VITE_API_URL || 'NOT SET'}</span>`, 'info');
                    addResult(`WebSocket URL: <span class="code">${window.__VITE_ENV.VITE_WEBSOCKET_URL || 'NOT SET'}</span>`, 'info');
                } else {
                    addResult('‚ùå No exposed environment variables found', 'error');
                    addResult('This suggests the build process may not be including environment variables', 'warning');
                }
            } else {
                addResult('‚úÖ import.meta.env is available', 'success');
                
                try {
                    const env = import.meta.env;
                    addResult(`Mode: <span class="code">${env.MODE || 'NOT SET'}</span>`, 'info');
                    addResult(`Production: <span class="code">${env.PROD || 'NOT SET'}</span>`, 'info');
                    addResult(`API URL: <span class="code">${env.VITE_API_URL || 'NOT SET'}</span>`, 'info');
                    addResult(`WebSocket URL: <span class="code">${env.VITE_WEBSOCKET_URL || 'NOT SET'}</span>`, 'info');
                    addResult(`Voice Enabled: <span class="code">${env.VITE_ENABLE_VOICE || 'NOT SET'}</span>`, 'info');
                    
                    // Check if the URLs are correct
                    if (env.VITE_WEBSOCKET_URL === 'wss://orderoverview-dkro.onrender.com') {
                        addResult('‚úÖ WebSocket URL is correctly set!', 'success');
                    } else if (!env.VITE_WEBSOCKET_URL || env.VITE_WEBSOCKET_URL === 'undefined') {
                        addResult('‚ùå WebSocket URL is not set - will fall back to localhost:3001', 'error');
                    } else {
                        addResult(`‚ö†Ô∏è WebSocket URL is set but incorrect: ${env.VITE_WEBSOCKET_URL}`, 'warning');
                    }
                } catch (error) {
                    addResult(`‚ùå Error accessing import.meta.env: ${error.message}`, 'error');
                }
            }
            
            // Show what URL would be used for WebSocket
            addResult('<strong>WebSocket Connection Analysis:</strong>', 'info');
            const wsUrl = getWebSocketUrl();
            addResult(`Will attempt to connect to: <span class="code">${wsUrl}</span>`, 'info');
            
            if (wsUrl.includes('localhost')) {
                addResult('üö® PROBLEM: Frontend is trying to connect to localhost!', 'error');
                addResult('This means environment variables are not properly set on Vercel.', 'error');
            } else if (wsUrl === 'wss://orderoverview-dkro.onrender.com') {
                addResult('‚úÖ Correct backend URL will be used', 'success');
            } else {
                addResult('‚ö†Ô∏è Unexpected WebSocket URL', 'warning');
            }
        });
        
        function getWebSocketUrl() {
            try {
                return import.meta.env.VITE_WEBSOCKET_URL || 'ws://localhost:3001';
            } catch {
                return window.__VITE_ENV?.VITE_WEBSOCKET_URL || 'ws://localhost:3001';
            }
        }
        
        function testWebSocket() {
            addWebSocketResult('üîå Testing WebSocket connection...', 'info');
            
            const wsUrl = getWebSocketUrl();
            addWebSocketResult(`Connecting to: <span class="code">${wsUrl}</span>`, 'info');
            
            const socket = io(wsUrl, {
                timeout: 10000,
                transports: ['websocket', 'polling']
            });
            
            let connected = false;
            
            socket.on('connect', () => {
                connected = true;
                addWebSocketResult(`‚úÖ Connected successfully! Socket ID: ${socket.id}`, 'success');
                addWebSocketResult(`Transport: ${socket.io.engine.transport.name}`, 'success');
                
                // Disconnect after success
                setTimeout(() => socket.disconnect(), 1000);
            });
            
            socket.on('connected', (data) => {
                addWebSocketResult(`üéâ LISA backend responded: ${data.agent}`, 'success');
                addWebSocketResult(`Session: ${data.sessionId}`, 'info');
            });
            
            socket.on('connect_error', (error) => {
                addWebSocketResult(`‚ùå Connection error: ${error.message}`, 'error');
                addWebSocketResult(`Error type: ${error.type}`, 'error');
                
                if (error.message.includes('xhr poll error')) {
                    addWebSocketResult('This suggests a CORS issue with XHR polling transport', 'warning');
                } else if (error.message.includes('websocket error')) {
                    addWebSocketResult('WebSocket transport failed, trying polling...', 'warning');
                }
            });
            
            socket.on('disconnect', (reason) => {
                addWebSocketResult(`üîå Disconnected: ${reason}`, 'info');
            });
            
            // Timeout after 15 seconds
            setTimeout(() => {
                if (!connected) {
                    addWebSocketResult('‚è∞ Connection test timeout', 'error');
                    socket.disconnect();
                }
            }, 15000);
        }
    </script>
</body>
</html>
